<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
    .container { max-width: 800px; background: white; padding: 30px; margin-top: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .header-box { text-align: center; margin-bottom: 20px; }
    .table-responsive { margin-top: 20px; border-radius: 8px; overflow: hidden; }
    th { background-color: #e9ecef !important; text-align: center; }
    td { vertical-align: middle; }
    .status-btn { width: 100%; }
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; display:none; justify-content:center; align-items:center; }
  </style>
</head>
<body>

  <div class="loading-overlay" id="loading">
    <div class="spinner-border text-primary" role="status"></div>
  </div>

  <div class="container">
    <div class="header-box">
      <h3> ระบบเช็คชื่อนักเรียน</h3>
    </div>

    <div class="row g-3">
      <div class="col-md-12">
        <label>วันที่</label>
        <input type="date" id="dateInput" class="form-control">
      </div>
      <div class="col-md-6">
        <label>ชั้น</label>
        <select id="levelSelect" class="form-select" onchange="loadStudents()">
        <option value="" selected disabled>โปรดเลือก</option>
        <option value="ม.1">ม.1</option>
        <option value="ม.2">ม.2</option>
        <option value="ม.3">ม.3</option>
        <option value="ม.4">ม.4</option>
        <option value="ม.5">ม.5</option>
        <option value="ม.6">ม.6</option>
        </select>
      </div>
      <div class="col-md-6">
        <label>ห้อง</label>
        <select id="roomSelect" class="form-select" onchange="loadStudents()">
        <option value="" selected disabled>โปรดเลือก</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
        <option value="21">21</option>
        <option value="22">22</option>
        <option value="23">23</option>
        <option value="24">24</option>
        <option value="25">25</option>
        <option value="26">26</option>
        </select>
      </div>
    </div>

    <div class="d-flex justify-content-center gap-2 mt-4">
      <button class="btn btn-success btn-sm" onclick="setAllStatus('มา')">มาทั้งหมด</button>
      <button class="btn btn-warning btn-sm" onclick="setAllStatus('ลา')">ลาทั้งหมด</button>
      <button class="btn btn-danger btn-sm" onclick="setAllStatus('ขาด')">ขาดทั้งหมด</button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th width="10%">ที่</th>
            <th width="50%">ชื่อนักเรียน</th>
            <th width="40%">สถานะ</th>
          </tr>
        </thead>
        <tbody id="studentTableBody">
          <tr><td colspan="3" class="text-center text-muted">กรุณาเลือกชั้นและห้อง</td></tr>
        </tbody>
      </table>
    </div>

    <div class="mt-3">
      <label>ผู้รายงาน</label>
      <select id="reporterSelect" class="form-select">
        <option value="ครูประจำชั้น">ครูประจำชั้น</option>
        <option value="หัวหน้าห้อง">หัวหน้าห้อง</option>
      </select>
    </div>

    <div class="row mt-4">
      <div class="col-6">
        <button class="btn btn-primary w-100" onclick="submitData()">บันทึกข้อมูล</button>
      </div>
      <div class="col-6">
        <button class="btn btn-secondary w-100" onclick="window.location.reload()">ล้างแบบฟอร์ม</button>
      </div>
    </div>

  </div>

  <script>
    document.getElementById('dateInput').valueAsDate = new Date();

    function loadStudents() {
      var level = document.getElementById('levelSelect').value;
      var room = document.getElementById('roomSelect').value;

      if(level && room) {
        document.getElementById('loading').style.display = 'flex';
        google.script.run.withSuccessHandler(renderTable).getStudentByClass(level, room);
      }
    }

    function renderTable(students) {
      document.getElementById('loading').style.display = 'none';
      var tbody = document.getElementById('studentTableBody');
      tbody.innerHTML = '';

      if(students.length == 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">ไม่พบรายชื่อนักเรียน</td></tr>';
        return;
      }

      students.forEach((name, index) => {
        var row = `
          <tr>
            <td class="text-center">${index + 1}</td>
            <td class="name-col">${name}</td>
            <td>
              <select class="form-select status-select">
                <option value="มา" selected>มา</option>
                <option value="ลา">ลา</option>
                <option value="ขาด">ขาด</option>
                <option value="สาย">สาย</option>
              </select>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    function setAllStatus(status) {
      var selects = document.querySelectorAll('.status-select');
      selects.forEach(s => s.value = status);
    }

    function submitData() {
      var level = document.getElementById('levelSelect').value;
      var room = document.getElementById('roomSelect').value;
      var rows = document.querySelectorAll('#studentTableBody tr');
      
      if(rows.length == 0 || !level) {
        alert('กรุณาเลือกห้องเรียนก่อน');
        return;
      }

      var dataList = [];
      rows.forEach(row => {
        var name = row.querySelector('.name-col').innerText;
        var status = row.querySelector('.status-select').value;
        dataList.push({name: name, status: status});
      });

      var payload = {
        date: document.getElementById('dateInput').value,
        level: level,
        room: room,
        reporter: document.getElementById('reporterSelect').value,
        list: dataList
      };

      if(confirm('ยืนยันการบันทึกข้อมูล?')) {
        document.getElementById('loading').style.display = 'flex';
        google.script.run.withSuccessHandler(function(res) {
          alert(res);
          document.getElementById('loading').style.display = 'none';
        }).saveAttendance(payload);
      }
    }
  </script>
</body>
</html>